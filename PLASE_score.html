<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PLASEスコア計算ツール</title>
  <style>
    :root{
      --bg:#fbf4f6; --card:#ffffff; --text:#3b3f46; --border:#ead7dd;
      --shadow:0 10px 26px rgba(120,55,75,.14);
      --accent:#c9738f;

      /* 夜勤でも眩しくない落ち着いた色（結果） */
      --low-bg:#eef6f1;  --low-bd:#b7dcc3;  --low-tx:#14532d;
      --mid-bg:#fff6e6;  --mid-bd:#f2cf84;  --mid-tx:#7c3f08;
      --high-bg:#fff1f2; --high-bd:#f0aebb; --high-tx:#881337;

      --num-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
    }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:radial-gradient(1200px 600px at 50% -10%, #fff, var(--bg));
      margin:0; color:var(--text);
    }

    .container{
      max-width:720px;
      margin:56px auto;
      background:var(--card);
      border-radius:16px;
      padding:30px 42px 36px;
      box-shadow:var(--shadow);
      border:1px solid rgba(234,215,221,.7);
    }

    h1{text-align:center;color:#8b3b55;margin:4px 0 18px;}

    .notice{
      background:#fff7fa; border:1px solid var(--border);
      border-left:6px solid var(--accent);
      padding:12px 16px; margin-bottom:18px;
      border-radius:10px; font-size:14px; line-height:1.65;
      color:#5b2b3c;
    }
    .ref{margin-top:8px;font-size:12px;color:#6b3b4c;}

    label{display:block;margin-top:14px;font-weight:650;color:#5a2336;}

    input{
      width:100%; padding:11px 12px; margin-top:6px;
      border-radius:10px; border:1px solid var(--border);
      font-size:16px; background:#fff;
      box-sizing:border-box;
    }
    input:focus{
      outline:none;
      border-color:rgba(201,115,143,.85);
      box-shadow:0 0 0 3px rgba(201,115,143,.18);
    }

    .ga-grid{
      display:grid; grid-template-columns:1fr auto 1fr auto;
      gap:10px; align-items:end; margin-top:6px;
    }
    @media(max-width:640px){
      .container{margin:22px auto;padding:22px 18px 28px;}
      .ga-grid{grid-template-columns:1fr auto;}
    }
    .unit{color:#8a5566;font-size:14px;padding-bottom:10px;}

    button{
      width:100%; margin-top:22px;
      background:linear-gradient(180deg,#d98aa3,var(--accent));
      color:#fff; padding:12px 14px;
      border:none; border-radius:12px;
      font-size:18px; cursor:pointer;
      box-shadow:0 10px 18px rgba(201,115,143,.22);
    }
    button:hover{ filter:brightness(0.98); }

    /* 結果：左右2カラム */
    .results{
      margin-top:22px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media(max-width:640px){
      .results{ grid-template-columns:1fr; }
    }

    .result{
      padding:16px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      min-height:106px; /* レイアウト安定 */
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      transition:background-color .18s ease, border-color .18s ease;
      background:#fff;
    }

    .prob-wrap{
      display:flex; flex-direction:column;
      align-items:center; gap:8px;
      width:100%;
    }

    .model-title{
      font-size:13px;
      font-weight:750;
      letter-spacing:.4px;
      color:#5a2336;
      opacity:.95;
    }

    .prob-label{
      font-size:12px;
      font-weight:650;
      letter-spacing:.35px;
      color:#5a2336;
      opacity:.85;
      margin-top:-2px;
    }

    .prob-value{
      font-family:var(--num-font);
      font-variant-numeric:tabular-nums;
      font-feature-settings:"tnum" 1, "lnum" 1;
      font-size:38px;
      font-weight:900;
      line-height:1.05;
      letter-spacing:.6px;
    }
    .prob-suffix{
      font-family:var(--num-font);
      font-size:19px;
      font-weight:850;
      margin-left:2px;
      opacity:.95;
    }

    /* 色分け（各カード単位） */
    .risk-low{background:var(--low-bg);border-color:var(--low-bd);}
    .risk-low .prob-value,.risk-low .prob-suffix{color:var(--low-tx);}

    .risk-mid{background:var(--mid-bg);border-color:var(--mid-bd);}
    .risk-mid .prob-value,.risk-mid .prob-suffix{color:var(--mid-tx);}

    .risk-high{background:var(--high-bg);border-color:var(--high-bd);}
    .risk-high .prob-value,.risk-high .prob-suffix{color:var(--high-tx);}

    .error{
      background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;
      justify-content:flex-start;text-align:left;
    }
    .error .prob-wrap{align-items:flex-start;}
  </style>
</head>

<body>
<div class="container">
  <h1>PLASEスコア計算ツール</h1>

  <div class="notice">
    <strong>概要：</strong>
    <u>在胎期間</u> と <u>日齢３の心エコー所見</u> から <strong>PDA手術予測確率</strong> を算出します。
    <div class="ref">
      Masutani, et al. Generation of PLASE score for patent ductus arteriosus using the PLASE study database.
      Pediatr Res. 2025;98:152-160.<br>
      Morita, et al. External Validation of the PLASE Score Prediction Model for PDA Surgery. Pediatr Cardiol. 2025 Nov 13. Online ahead of print.
    </div>
  </div>

  <label for="pdad">PDA径（mm）</label>
  <input type="number" id="pdad" step="0.1" placeholder="例：2.3" />

  <label for="lpaedv">LPA拡張末期流速（cm/s）</label>
  <input type="number" id="lpaedv" step="0.1" placeholder="例：18.0" />

  <label for="laao">LA/Ao比</label>
  <input type="number" id="laao" step="0.01" placeholder="例：1.45" />

  <label>在胎期間</label>
  <div class="ga-grid">
    <input type="number" id="gaWeeks" placeholder="例：26">
    <div class="unit">週</div>
    <input type="number" id="gaDays" placeholder="例：3" min="0" max="6">
    <div class="unit">日</div>
  </div>

  <button onclick="calculate()">計算</button>

  <div class="results">
    <div class="result" id="resultV1"></div>
    <div class="result" id="resultV2"></div>
  </div>
</div>

<script>
function n(v){const x=parseFloat(String(v??"").trim());return Number.isFinite(x)?x:null;}
function logistic(x){return 1/(1+Math.exp(-x));}
function setClass(el, cls){
  el.classList.remove("risk-low","risk-mid","risk-high","error");
  if (cls) el.classList.add(cls);
}
function classify(p){
  if (p >= 0.50) return "risk-high";
  if (p >= 0.25) return "risk-mid";
  return "risk-low";
}
function render(el, modelTitle, pctText, cls){
  setClass(el, cls);
  el.innerHTML = `
    <div class="prob-wrap">
      <div class="model-title">${modelTitle}</div>
      <div class="prob-label">予測確率</div>
      <div>
        <span class="prob-value">${pctText}</span><span class="prob-suffix">%</span>
      </div>
    </div>
  `;
}
function renderError(el, modelTitle, msg){
  el.className = "result error";
  el.innerHTML = `
    <div class="prob-wrap">
      <div class="model-title">${modelTitle}</div>
      <div><strong>エラー：</strong><br>${msg}</div>
    </div>
  `;
}

function calculate(){
  const el1 = document.getElementById("resultV1");
  const el2 = document.getElementById("resultV2");

  const pd = n(document.getElementById("pdad").value);
  const lp = n(document.getElementById("lpaedv").value);
  const la = n(document.getElementById("laao").value);
  const gw = n(document.getElementById("gaWeeks").value);
  const gd = n(document.getElementById("gaDays").value);

  const errors = [];
  if (pd === null) errors.push("PDA径");
  if (lp === null) errors.push("LPA拡張末期流速");
  if (la === null) errors.push("LA/Ao比");
  if (gw === null) errors.push("在胎期間（週）");
  if (gd === null) errors.push("在胎期間（日）");
  if (gd !== null && (gd < 0 || gd > 6)) errors.push("在胎期間（日）は0〜6");

  if (errors.length){
    const msg = "入力を確認してください：<br>・" + errors.join("<br>・");
    renderError(el1, "Masutani (v1)", msg);
    renderError(el2, "Morita (v2)", msg);
    return;
  }

  const GA = gw + gd/7;

  // v1: Masutani
  const logit1 =
    10.7091 +
    1.141 * pd +
    0.036 * lp +
    0.6356 * la -
    0.5652 * GA;

  // v2: Morita
  const logit2 =
    12.5147 +
    1.1608 * pd +
    0.0289 * lp +
    0.2176 * la -
    0.6119 * GA;

  const p1 = logistic(logit1);
  const p2 = logistic(logit2);

  render(el1, "Masutani (v1)", (p1*100).toFixed(1), classify(p1));
  render(el2, "Morita (v2)", (p2*100).toFixed(1), classify(p2));
}

// 初期表示（高さ・レイアウト安定のため）
(function init(){
  render(document.getElementById("resultV1"), "Masutani (v1)", "—", "");
  render(document.getElementById("resultV2"), "Morita (v2)", "—", "");
})();
</script>
</body>
</html>
